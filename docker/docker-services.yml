services:
  eureka-server:
    container_name: eureka-server
    build:
      context: ../
      dockerfile: services/eureka-server/Dockerfile
    ports:
      - "8761:8761"
    env_file:
      - ".env"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - restbank-net

  api-gateway:
    container_name: api-gateway
    build:
      context: ../
      dockerfile: services/api-gateway/Dockerfile
    ports:
      - "1024:1024"
      - "1042:8081"
    env_file:
      - ".env"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - restbank-net
    depends_on:
      eureka-server:
        condition: service_started
      keycloak:
        condition: service_healthy

  auth-service:
    container_name: auth-service
    build:
      context: ../
      dockerfile: services/auth-service/Dockerfile
    env_file:
      - ".env"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - restbank-net
    depends_on:
      eureka-server:
        condition: service_healthy
      api-gateway:
        condition: service_healthy

  card-service:
    container_name: card-service
    build:
      context: ../
      dockerfile: services/card-service/Dockerfile
    env_file:
      - ".env"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - restbank-net
    depends_on:
      eureka-server:
        condition: service_healthy
      api-gateway:
        condition: service_healthy

  customer-service:
    container_name: customer-service
    build:
      context: ../
      dockerfile: services/customer-service/Dockerfile
    env_file:
      - ".env"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - restbank-net
    depends_on:
      eureka-server:
        condition: service_healthy
      api-gateway:
        condition: service_healthy

networks:
  restbank-net:
    driver: bridge